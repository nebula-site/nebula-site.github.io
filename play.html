<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nebula | Play</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.png" />
    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="stylesheet" href="/css/menu.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/viewers.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
    }

    #game-container {
        height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    /* Header */
    #game-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 24px;
        padding: 16px 0;
        z-index: 99999; /* navbar-safe */
        position: relative;
    }

    #iframe-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 0;
        z-index: 0;
    }

    #iframe-container iframe {
        width: 100%;
        height: 100%;
        border: 0;
        background: #000;
    }

    /* Fullscreen mode */
    #iframe-container.fullscreen {
        position: fixed;
        inset: 0;
        z-index: 9990; /* BELOW NAVBAR */
        background: #000;
    }

    /* Bottom button bar */
    .container {
        padding: 18px 0;
        text-align: center;
        z-index: 99999; /* navbar-safe */
        position: relative;
    }

    .buttons-container {
        display: flex;
        justify-content: center;
        gap: 24px;
    }

    .buttons-container button {
        background: #111;
        color: #a3f7ff;
        border: 2px solid #3f00ff;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 0 12px #3f00ff44;
        transition: 0.15s;
    }
    .buttons-container button:hover {
        background: #1a0033;
    }

    /* Make navbar ALWAYS stay above fullscreen */
    nav.navbar {
        z-index: 999999 !important;
        position: fixed !important;
    }

    #profile-float {
        z-index: 999999 !important;
        position: fixed !important;
    }

    #particles-js {
        position: fixed;
        inset: 0;
        z-index: -1;
    }
</style>
</head>

<body>

<!-- NAVBAR (auto-added by JS) -->

<div id="game-container">

    <!-- TOP HEADER -->
    <div id="game-header">
        <img id="game-image" src="" alt="Game"
             style="width:80px; height:80px; border-radius:18px; box-shadow:0 4px 16px #a3f7ff44; background:#1a0033; border:2px solid #3f00ff; object-fit:cover; display:none;">
        <h2 id="game-name" style="margin:0; color:#a3f7ff; font-family:'Bebas Neue', cursive;"></h2>
    </div>

    <!-- GAME -->
    <div id="iframe-container">
        <iframe id="myIframe"
            src=""
            allow="autoplay; fullscreen; encrypted-media; picture-in-picture; web-share"
            sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    </div>

    <!-- BOTTOM BUTTONS -->
    <div class="container">
        <div class="buttons-container">
            <button onclick="goHome()" title="Back to games">
                <i class="fa fa-house fa-lg"></i>
            </button>

            <button id="fullscreenButton" onclick="makeFullscreen()" title="Fullscreen">
                <i class="fa-solid fa-up-right-and-down-left-from-center fa-lg"></i>
            </button>

            <button id="reloadButton" onclick="reloadIframe()" title="Reload">
                <i class="fa fa-refresh fa-lg"></i>
            </button>
        </div>
    </div>

</div>

<div id="particles-js"></div>

<script>
function pausePageEffects() {
    const p = document.getElementById('particles-js');
    if (p) p.style.display = 'none';
}

function restorePageEffects() {
    const p = document.getElementById('particles-js');
    if (p) p.style.display = '';
}

window.addEventListener('load', function () {
    const gameLink = sessionStorage.getItem('gameLink');
    const gameName = sessionStorage.getItem('gameName');
    const gameImage = sessionStorage.getItem('gameImage');

    if (gameLink && gameName) {
        document.getElementById('game-name').innerText = gameName;

        const img = document.getElementById('game-image');
        if (gameImage) {
            img.src = gameImage;
            img.style.display = 'block';
        }

        startGame();
    } else {
        window.location.href = "/games";
    }
});

function startGame() {
    const gameLink = sessionStorage.getItem('gameLink') || '';
    const iframe = document.getElementById('myIframe');

    pausePageEffects();

    let finalSrc = gameLink;
    if (!finalSrc.startsWith('http') && !finalSrc.startsWith('/'))
        finalSrc = '/' + finalSrc;

    iframe.src = finalSrc;
    iframe.style.display = 'block';
}

function reloadIframe() {
    const iframe = document.getElementById('myIframe');
    const currentSrc = iframe.src || sessionStorage.getItem('gameLink') || '';
    const reloadButton = document.getElementById('reloadButton');

    reloadButton.querySelector("i").classList.add("fa-spin");
    iframe.src = '';

    setTimeout(() => {
        iframe.src = currentSrc;
        reloadButton.querySelector("i").classList.remove("fa-spin");
    }, 150);
}

document.addEventListener("DOMContentLoaded", function () {
    const reloadButton = document.getElementById('reloadButton');
    reloadButton.addEventListener("mouseenter", () => reloadButton.querySelector("i").classList.add("fa-spin"));
    reloadButton.addEventListener("mouseleave", () => reloadButton.querySelector("i").classList.remove("fa-spin"));
});

function makeFullscreen() {
    const container = document.getElementById('iframe-container');

    if (container.requestFullscreen) container.requestFullscreen();
    else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
    else if (container.mozRequestFullScreen) container.mozRequestFullScreen();
    else if (container.msRequestFullscreen) container.msRequestFullscreen();

    container.classList.add('fullscreen');
    pausePageEffects();
}

function goHome() {
    restorePageEffects();
    window.location.href = "/games";
}

const fsEvents = [
    'fullscreenchange', 'webkitfullscreenchange',
    'mozfullscreenchange', 'msfullscreenchange'
];

fsEvents.forEach(eventName => {
    document.addEventListener(eventName, () => {
        const container = document.getElementById('iframe-container');
        const full = document.fullscreenElement || document.webkitFullscreenElement ||
                     document.mozFullScreenElement || document.msFullscreenElement;

        if (!full) {
            container.classList.remove('fullscreen');
            setTimeout(restorePageEffects, 300);
        }
    });
});
</script>

<script src="/js/profile.js"></script>
<script src="/js/navbar.js"></script>

</body>
</html>
