<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile & Admin Panel â€“ Nebula</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.png" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/navbar.css" defer/>
    <link rel="stylesheet" href="/css/desc.css" />
    <link rel="stylesheet" href="/css/home.css" />
</head>
<body>
    <style>
body {
    background-color: #f4f4f4;
    font-family: Arial, sans-serif;
    color: #333;
    margin: 0;
    padding: 0;
}

/* Base Styles from the provided HTML */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(135deg, #1a0033 0%, #0d001f 100%);
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

main {
    max-width: 900px;
    margin: 40px auto;
    padding: 24px;
    text-align: left;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(8px);
    flex: 1;
    width: 90%;
}

h1 {
    color: #a3f7ff;
    text-align: center;
    margin-bottom: 12px;
}

h2 {
    color: #a3f7ff;
    margin-bottom: 12px;
}

p {
    color: #ccc;
}

#profile-status {
    text-align: center;
    color: #ccc;
    margin-bottom: 24px;
}

/* Buttons */
.btn {
    padding: 10px 16px;
    border-radius: 8px;
    color: white;
    border: 0;
    cursor: pointer;
    transition: 0.2s;
    font-weight: 500;
    font-size: 0.95rem;
}

.btn:active {
    transform: scale(0.98);
}

.btn-primary {
    background: #1a73e8;
}

.btn-primary:hover {
    background: #1557b0;
}

.btn-secondary {
    background: #6c5ce7;
}

.btn-secondary:hover {
    background: #5f46d4;
}

.btn-danger {
    background: #ff6b6b;
}

.btn-danger:hover {
    background: #ee5a52;
}

.btn-tertiary {
    background: #00b894;
}

.btn-tertiary:hover {
    background: #00a584;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Profile Card */
#profile-card {
    display: none;
    align-items: center;
    gap: 24px;
    padding: 24px;
    border-radius: 12px;
    background: rgba(30, 0, 60, 0.12);
    margin-bottom: 24px;
}

#profile-card.show {
    display: flex;
}

#profile-pic {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(163, 247, 255, 0.3);
    flex-shrink: 0;
}

.profile-info {
    flex: 1;
}

.profile-info div {
    margin-bottom: 12px;
}

.label {
    opacity: 0.7;
    font-size: 0.85rem;
    color: #a3f7ff;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.value {
    font-weight: 500;
    color: white;
    font-size: 1.1rem;
}

.profile-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.auth-section {
    text-align: center;
}

.auth-buttons {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
}

hr {
    margin: 24px 0;
    border: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.2);
}

/* Modals */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: rgba(30, 0, 60, 0.95);
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(163, 247, 255, 0.2);
    max-width: 500px;
    width: 90%;
}

.modal-content h2 {
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #a3f7ff;
    font-size: 0.9rem;
    font-weight: 600;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(163, 247, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    color: white;
    font-size: 0.95rem;
}

.form-group input:focus {
    outline: none;
    border-color: #a3f7ff;
    background: rgba(255, 255, 255, 0.1);
}

.avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(163, 247, 255, 0.3);
    margin-top: 8px;
}

.file-input-wrapper {
    position: relative;
    display: inline-block;
    margin-top: 12px;
}

#avatarUpload {
    display: none;
}

.upload-btn {
    padding: 10px 16px;
    background: #6c5ce7;
    color: white;
    border: 1px dashed rgba(163, 247, 255, 0.5);
    border-radius: 8px;
    cursor: pointer;
    transition: 0.2s;
}

.upload-btn:hover {
    background: #5f46d4;
    border-color: #a3f7ff;
}

.modal-buttons {
    display: flex;
    gap: 8px;
    margin-top: 24px;
}

.modal-buttons button {
    flex: 1;
}

.error {
    background: rgba(255, 107, 107, 0.1);
    border: 1px solid #ff6b6b;
    color: #ff8787;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 0.9rem;
}

.success {
    background: rgba(0, 184, 148, 0.1);
    border: 1px solid #00b894;
    color: #1dd1a1;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 0.9rem;
}

.switch-auth-text {
    text-align: center;
    margin-top: 16px;
    color: #aaa;
    font-size: 0.9rem;
}

.switch-auth-text button {
    background: none;
    border: none;
    color: #a3f7ff;
    cursor: pointer;
    text-decoration: underline;
    font-weight: 600;
}

.switch-auth-text button:hover {
    color: #fff;
}

/* Footer */
footer {
    background: rgba(30, 0, 60, 0.9);
    color: white;
    padding: 20px;
    text-align: center;
    border-top: 2px solid #3f00ff88;
    margin-top: auto;
}

footer a {
    color: #a3f7ff;
    margin: 0 10px;
    text-decoration: none;
}

footer a:hover {
    text-decoration: underline;
}

.icon {
    width: 80px;
    height: 80px;
    margin: 40px auto 20px;
    display: block;
}

/* Navbar Styles for Floating Profile */
/* NOTE: These styles should ideally be in /css/navbar.css */
.navbar {
    position: fixed;
    bottom: 0;
    left: 0;
    height: 100vh;
    width: 60px;
    background: rgba(30, 0, 60, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 0;
    transition: width 0.3s;
    z-index: 100;
}

.navbar:hover {
    width: 220px;
}

.nav-left-bg {
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    width: 100%;
}

.logo img {
    width: 40px;
    height: 40px;
    margin-bottom: 20px;
}

.nav-links {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    flex: 1;
    overflow: hidden;
    position: relative;
}

.nav-links a {
    color: #a3f7ff;
    text-decoration: none;
    padding: 10px 18px;
    display: flex;
    align-items: center;
    transition: background 0.2s, color 0.2s;
    white-space: nowrap;
}

.nav-links a:hover {
    background: rgba(163, 247, 255, 0.1);
}

.nav-links a i {
    font-size: 1.2rem;
    width: 20px;
    margin-right: 15px;
}

#profile-float {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    background: rgba(30, 0, 60, 0.9);
    padding: 8px 15px;
    border-radius: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    color: white;
    text-decoration: none;
    z-index: 100;
    transition: background 0.2s;
}

#profile-float:hover {
    background: rgba(40, 10, 80, 0.9);
}

#profile-float-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
}

#profile-float-name {
    font-weight: 600;
}

.extra {
    margin-top: auto;
    /* Pushes to bottom */
}

.extra-buttons {
    position: absolute;
    bottom: 50px;
    left: 60px;
    display: flex;
    flex-direction: column;
    background: rgba(30, 0, 60, 0.9);
    border-radius: 8px;
    box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s, transform 0.3s;
    transform: translateY(10px);
}

.extra-buttons a {
    padding: 8px 15px;
}

.extra-buttons a:first-child {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
}

.extra-buttons a:last-child {
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
}

#nebula-auth-toast {
    position: fixed;
    right: 20px;
    bottom: 90px;
    background: #1a73e8;
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    z-index: 2000;
    font-weight: 600;
    opacity: 0;
    transition: opacity 0.3s;
}
    </style>
</head>

<body>
    <div id="buttonContainer" style="display:none;"></div>

    <img class="icon" src="images/favicon.png" alt="Nebula Icon">

    <main>
        <h1>Your Profile</h1>
        <p id="profile-status">Loading...</p>
        <div id="error-message" class="error" style="display: none;"></div>
        <div id="success-message" class="success" style="display: none;"></div>

        <section id="profile-card">
            <img id="profile-pic" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23a3f7ff' opacity='0.2'/%3E%3Ccircle cx='50' cy='50' r='35' fill='none' stroke='%23a3f7ff' stroke-width='2'/%3E%3C/svg%3E" alt="avatar">
            <div class="profile-info">
                <div>
                    <div class="label">Username</div>
                    <div class="value" id="profile-name">User</div>
                </div>
                <div>
                    <div class="label">Email</div>
                    <div class="value" id="profile-email">user@example.com</div>
                </div>
                <div class="profile-actions">
                    <button class="btn btn-secondary" id="editProfileBtn">âœŽ Edit Profile</button>
                    <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
                </div>
            </div>
        </section>

        <section id="auth-section" class="auth-section">
            <h2>Welcome to Nebula</h2>
            <p>Sign in or create an account to get started</p>
            <div class="auth-buttons">
                <button class="btn btn-primary" id="signInBtn">Sign In</button>
                <button class="btn btn-secondary" id="signUpBtn">Sign Up</button>
            </div>
        </section>

    </main>

    <div id="signInModal" class="modal">
        <div class="modal-content">
            <h2>Sign In</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signInEmail" placeholder="your@email.com" />
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signInPassword" placeholder="Enter your password" />
            </div>
            <div class="modal-buttons">
                <button class="btn btn-tertiary" id="loginBtn">Sign In</button>
                <button class="btn btn-danger" id="closeSignInBtn">Cancel</button>
            </div>
            <div class="switch-auth-text">
                Don't have an account? <button id="switchToSignUp">Sign Up</button>
            </div>
        </div>
    </div>

    <div id="signUpModal" class="modal">
        <div class="modal-content">
            <h2>Create Account</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signUpEmail" placeholder="your@email.com" />
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="signUpUsername" placeholder="Choose a username" />
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signUpPassword" placeholder="At least 6 characters" />
            </div>
            <div class="modal-buttons">
                <button class="btn btn-tertiary" id="createAccountBtn">Create Account</button>
                <button class="btn btn-danger" id="closeSignUpBtn">Cancel</button>
            </div>
            <div class="switch-auth-text">
                Already have an account? <button id="switchToSignIn">Sign In</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Edit Profile</h2>
            <div class="form-group">
                <label>Avatar</label>
                <img id="avatarPreview" class="avatar-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23a3f7ff' opacity='0.2'/%3E%3Ccircle cx='50' cy='50' r='35' fill='none' stroke='%23a3f7ff' stroke-width='2'/%3E%3C/svg%3E" alt="avatar preview">
                <div class="file-input-wrapper">
                    <input type="file" id="avatarUpload" accept="image/*" />
                    <button type="button" class="upload-btn" id="uploadAvatarBtn">ðŸ“¤ Upload Avatar</button>
                </div>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="editUsername" placeholder="Enter your username" />
            </div>
            <div class="modal-buttons">
                <button class="btn btn-tertiary" id="saveProfileBtn">Save Changes</button>
                <button class="btn btn-danger" id="closeEditBtn">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        <p style="margin: 0;">Nebula â€” gaming meets reality!</p>
        <nav style="margin-top: 8px;">
            <a href="/privacy.html">Privacy Policy</a>
            <a href="/terms.html">Terms of Service</a>
            <a href="/contact.html">Contact Us</a>
        </nav>
    </footer>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // --- Supabase and Global Constants ---
        const SUPABASE_URL = 'https://lhurtuuxsmlakoikcpiz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxodXJ0dXV4c21sYWtvaWtjcGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTIyNjEsImV4cCI6MjA3OTE2ODI2MX0.NiXIlUukeNB-gOANdbHSyfb6T9GcO7QqtlMsQgkEGKc';
        const MAX_FILE_SIZE = 500 * 1024; // 500 KB limit for avatar uploads
        const ADMIN_EMAIL_CHECK = 'REESDOLSEN@GMAIL.COM'.toUpperCase().trim();
        const STORAGE_KEY = 'nebula_profile'; // Consolidated storage key

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase initialized:', !!supabase);

        const defaultAvatar = "/images/user.png"; // Changed from SVG data URL to external image for consistency
        const defaultAvatarSVG = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%23a3f7ff" opacity="0.2"/%3E%3Ccircle cx="50" cy="50" r="35" fill="none" stroke="%23a3f7ff" stroke-width="2"/%3E%3C/svg%3E';

        // --------------------------
        // UTILITY FUNCTIONS (Storage, Toast, Admin Check)
        // --------------------------

        // Consolidated Local Storage for single object storage (better for utility script)
        function saveProfileToStorage(profile) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
                updateFloatingProfile(profile);
                checkAdminStatusAndDispatch(profile);
                return profile;
            } catch (e) {
                console.error('Storage error:', e);
            }
        }

        function getProfileFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : null;
            } catch (e) {
                console.error('Storage read error:', e);
                return null;
            }
        }

        function clearProfileStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                updateFloatingProfile(null);
                checkAdminStatusAndDispatch(null);
            } catch (e) {
                console.error('Storage error:', e);
            }
        }

        function showAuthToast(msg = 'Sign in required') {
            let t = document.getElementById('nebula-auth-toast');
            if (!t) {
                t = document.createElement('div');
                t.id = 'nebula-auth-toast';
                // Styles are in the <style> block now, but inline for fallback/clarity
                t.style = 'position:fixed;right:20px;bottom:90px;background:#1a73e8;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.4);z-index:2000;font-weight:600;opacity:0;transition:opacity 0.3s;';
                document.body.appendChild(t);
            }
            t.textContent = msg;
            t.style.opacity = '1';
            clearTimeout(t._hideTimer);
            t._hideTimer = setTimeout(() => { t.style.opacity = '0'; }, 2200);
        }

        function checkAdminStatusAndDispatch(profile) {
            const currentProfile = profile || getProfileFromStorage();
            const currentUserEmail = currentProfile?.email?.toUpperCase().trim() || null;
            const isAdmin = currentUserEmail === ADMIN_EMAIL_CHECK;

            console.log(`[Admin Check Dispatch - Navbar] User: ${currentUserEmail || 'None'} | IsAdmin: ${isAdmin}`);

            window.dispatchEvent(new CustomEvent('adminStatusChecked', {
                detail: { isAdmin: isAdmin, email: currentUserEmail }
            }));
        }

        function isSignedIn() {
            try {
                const p = getProfileFromStorage();
                return !!(p && (p.email || p.name));
            } catch (e) {
                return false;
            }
        }

        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('success-message');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                if (file.size > MAX_FILE_SIZE) {
                    reject(new Error(`File size exceeds ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(2)}MB limit. Your file is ${(file.size / 1024 / 1024).toFixed(2)}MB`));
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }


        // --------------------------
        // UI UPDATE FUNCTIONS (Specific to Profile Page)
        // --------------------------

        function showProfile(user) {
            // Map Supabase user data to a simplified profile object
            const profile = {
                name: user?.user_metadata?.full_name || user?.full_name || user?.email || 'User',
                avatar: user?.user_metadata?.avatar_url || user?.avatar_url || user?.avatar || defaultAvatar,
                email: user?.email || getProfileFromStorage()?.email || '(no email)'
            };

            // Save the comprehensive profile object to the consolidated storage key
            saveProfileToStorage(profile);

            // Update Profile Card
            document.getElementById('profile-status').textContent = `Signed in as ${profile.email}`;
            document.getElementById('profile-name').textContent = profile.name;
            document.getElementById('profile-email').textContent = profile.email;
            document.getElementById('profile-pic').src = profile.avatar;
            document.getElementById('profile-card').classList.add('show');
            document.getElementById('auth-section').style.display = 'none';

            // Populate Edit Modal
            document.getElementById('editUsername').value = profile.name;
            document.getElementById('avatarPreview').src = profile.avatar;
        }

        function hideProfile() {
            clearProfileStorage();

            document.getElementById('profile-status').textContent = 'Not signed in.';
            document.getElementById('profile-card').classList.remove('show');
            document.getElementById('auth-section').style.display = 'block';

            // Reset Modals
            document.getElementById('editModal').classList.remove('show');
            document.getElementById('signInModal').classList.remove('show');
            document.getElementById('signUpModal').classList.remove('show');
        }

        function updateFloatingProfile(profile) {
            const img = document.getElementById('profile-float-img');
            const name = document.getElementById('profile-float-name');

            if (!img || !name) return; // Exit if elements aren't injected yet

            if (!profile) {
                img.src = defaultAvatar;
                name.textContent = "Sign In";
            } else {
                img.src = profile.avatar || profile.picture || defaultAvatar;
                name.textContent = profile.name || profile.username || "User";
            }
        }


        // --------------------------
        // DOM CONTENT LOADED - MAIN EXECUTION
        // --------------------------

        document.addEventListener('DOMContentLoaded', () => {

            /* ==================================
                NAVBAR AND FLOATING PROFILE INJECTION
            ================================== */
            const navbarHTML = `
                <nav class="navbar">
                    <div class="nav-left-bg">
                        <a href="/" class="logo">
                            <img src="/images/favicon.png">
                        </a>
                        <div class="nav-links">
                            <a href="/home"><i class="fa fa-home"></i></a>
                            <a href="/games"><i class="fa fa-gamepad"></i></a>
                            <a href="/ai"><i class="fa fa-robot"></i></a>
                            <a href="/forms"><i class="fa fa-clipboard-list"></i></a>
                            <a href="/profile"><i class="fa fa-user"></i></a>
                            <a href="/reviews"><i class="fa fa-star"></i></a>
                            <a href="/admin" id="admin-nav-btn" style="display:none;">
                                <i class="fa fa-crown"></i>
                            </a>
                            <a class="extra"><i class="fa fa-plus"></i></a>
                            <div class="extra-buttons">
                                <a href="https://github.com/nebula-site" target="_blank"><i class="fa-brands fa-github"></i></a>
                                <a href="/terms"><i class="fa fa-clipboard-check"></i></a>
                                <a href="/privacy"><i class="fa fa-user-lock"></i></a>
                                <a href="/contact"><i class="fa fa-envelope"></i></a>
                            </div>
                        </div>
                    </div>
                </nav>
            `;
            document.body.insertAdjacentHTML("afterbegin", navbarHTML);

            const profileLink = document.createElement("a");
            profileLink.href = "/profile";
            profileLink.id = "profile-float";
            profileLink.innerHTML = `
                <img id="profile-float-img" src="${defaultAvatar}">
                <span id="profile-float-name">Guest</span>
            `;
            document.body.appendChild(profileLink);
            
            // Initial UI Update from Local Storage (for floating profile)
            const storedProfile = getProfileFromStorage();
            if (storedProfile) {
                updateFloatingProfile(storedProfile);
                checkAdminStatusAndDispatch(storedProfile);
            } else {
                updateFloatingProfile(null);
            }

            /* ==================================
                EVENT LISTENERS (from profile.js and navbar.js)
            ================================== */

            // --- Navigation Guard (from navbar.js) ---
            document.addEventListener('click', (ev) => {
                const a = ev.target.closest && ev.target.closest('a');
                if (!a) return;

                if (a.target === '_blank') return;
                const href = a.getAttribute('href');
                if (!href) return;

                if (href.startsWith('mailto:') || href.startsWith('tel:') || href.startsWith('#')) return;

                try {
                    const url = new URL(href, window.location.origin);
                    if (url.origin !== window.location.origin) return;

                    const path = url.pathname || '/';
                    const allowedPublic = ['/', '/profile', '/privacy', '/terms', '/contact'];
                    if (isSignedIn()) return;

                    if (!allowedPublic.includes(path)) {
                        ev.preventDefault();
                        try { sessionStorage.setItem('postAuthRedirect', path + url.search); } catch(e) {}
                        showAuthToast('Please sign in first â€” redirecting to Profile');
                        window.location.href = '/profile';
                    }
                } catch (e) {
                    return;
                }
            });

            // --- Cross-tab/Window Storage Listener (from navbar.js) ---
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    const updated = e.newValue ? JSON.parse(e.newValue) : null;
                    updateFloatingProfile(updated);
                    checkAdminStatusAndDispatch(updated);
                    // Also update the main profile card if we are on the profile page
                    if (document.getElementById('profile-card')) {
                         if (updated) showProfile(updated); else hideProfile();
                    }
                }
            });

            // --- Admin Status Listener (from navbar.js) ---
            window.addEventListener('adminStatusChecked', (e) => {
                const btn = document.getElementById('admin-nav-btn');
                if (!btn) return;
                btn.style.display = e.detail.isAdmin ? "inline-flex" : "none";
            });

            // --- Extras Menu Toggle (from navbar.js) ---
            const extraBtn = document.querySelector(".extra");
            const menu = document.querySelector(".extra-buttons");
            if (extraBtn && menu) {
                extraBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const open = menu.style.opacity === "1";

                    if (open) {
                        menu.style.opacity = "0";
                        menu.style.pointerEvents = "none";
                        menu.style.transform = "translateY(10px)";
                        extraBtn.innerHTML = `<i class="fa fa-plus"></i>`;
                    } else {
                        menu.style.opacity = "1";
                        menu.style.pointerEvents = "auto";
                        menu.style.transform = "translateY(0)";
                        extraBtn.innerHTML = `<i class="fa fa-minus"></i>`;
                    }
                });

                document.addEventListener("click", () => {
                    menu.style.opacity = "0";
                    menu.style.pointerEvents = "none";
                    menu.style.transform = "translateY(10px)";
                    extraBtn.innerHTML = `<i class="fa fa-plus"></i>`;
                });
            }


            // --- Profile Edit Handlers (from profile.js) ---
            document.getElementById('uploadAvatarBtn').addEventListener('click', () => {
                document.getElementById('avatarUpload').click();
            });

            document.getElementById('avatarUpload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const base64 = await imageToBase64(file);
                    document.getElementById('avatarPreview').src = base64;
                    document.getElementById('avatarUpload').dataset.base64 = base64;
                } catch (err) {
                    showError(err.message);
                }
            });

            document.getElementById('saveProfileBtn').addEventListener('click', async () => {
                const newUsername = document.getElementById('editUsername').value.trim();
                const avatarUploadEl = document.getElementById('avatarUpload');
                const avatarData = avatarUploadEl.dataset.base64 || null;
                // Use current profile pic if no new file/base64 data
                const currentProfile = getProfileFromStorage(); 
                const finalAvatarUrl = avatarData || currentProfile?.avatar || defaultAvatar;

                if (!newUsername) {
                    showError('Username cannot be empty');
                    return;
                }

                try {
                    const { data, error } = await supabase.auth.updateUser({
                        data: {
                            full_name: newUsername,
                            avatar_url: finalAvatarUrl
                        }
                    });

                    if (error) {
                        showError('Error updating profile: ' + error.message);
                        return;
                    }

                    showSuccess('Profile updated successfully!');
                    document.getElementById('editModal').classList.remove('show');

                    delete avatarUploadEl.dataset.base64;
                    avatarUploadEl.value = '';

                    // Reload session data to ensure we have the most current info
                    const { data: sessionData } = await supabase.auth.getSession();
                    showProfile(sessionData.session.user || { full_name: newUsername, avatar_url: finalAvatarUrl, email: currentProfile.email });

                } catch (e) {
                    showError('Error: ' + (e.message || e));
                }
            });

            // --- Modal and Auth Button Handlers (from profile.js) ---
            document.getElementById('signInBtn').addEventListener('click', () => document.getElementById('signInModal').classList.add('show'));
            document.getElementById('closeSignInBtn').addEventListener('click', () => document.getElementById('signInModal').classList.remove('show'));
            document.getElementById('signUpBtn').addEventListener('click', () => document.getElementById('signUpModal').classList.add('show'));
            document.getElementById('closeSignUpBtn').addEventListener('click', () => document.getElementById('signUpModal').classList.remove('show'));
            document.getElementById('editProfileBtn').addEventListener('click', () => document.getElementById('editModal').classList.add('show'));
            document.getElementById('closeEditBtn').addEventListener('click', () => document.getElementById('editModal').classList.remove('show'));

            document.getElementById('switchToSignUp').addEventListener('click', () => { document.getElementById('signInModal').classList.remove('show'); document.getElementById('signUpModal').classList.add('show'); });
            document.getElementById('switchToSignIn').addEventListener('click', () => { document.getElementById('signUpModal').classList.remove('show'); document.getElementById('signInModal').classList.add('show'); });

            document.getElementById('signOutBtn').addEventListener('click', async () => {
                await supabase.auth.signOut();
                hideProfile();
                showSuccess('Signed out successfully');
            });

            document.getElementById('loginBtn').addEventListener('click', async () => {
                const email = document.getElementById('signInEmail').value.trim();
                const password = document.getElementById('signInPassword').value;

                if (!email || !password) return showError('Please fill in all fields');

                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) return showError('Sign in failed: ' + error.message);

                showProfile(data.user);
                showSuccess('Signed in successfully!');
                document.getElementById('signInModal').classList.remove('show');
                // Handle redirect if one was saved
                const redirect = sessionStorage.getItem('postAuthRedirect');
                if (redirect) {
                    sessionStorage.removeItem('postAuthRedirect');
                    window.location.href = redirect;
                }
            });

            document.getElementById('createAccountBtn').addEventListener('click', async () => {
                const email = document.getElementById('signUpEmail').value.trim();
                const username = document.getElementById('signUpUsername').value.trim();
                const password = document.getElementById('signUpPassword').value;

                if (!email || !password || !username) return showError('Please fill in all fields');
                if (password.length < 6) return showError('Password must be at least 6 characters');

                const { data, error } = await supabase.auth.signUp({
                    email, password, options: { data: { full_name: username, avatar_url: defaultAvatar } }
                });

                if (error) return showError('Sign up failed: ' + error.message);

                showSuccess('Account created! Please check your email for a verification link.');
                document.getElementById('signUpModal').classList.remove('show');
            });


            // --- Supabase Auth State Change Listener ---
            supabase.auth.onAuthStateChange((event, session) => {
                const u = session?.user;
                if (u) {
                    showProfile(u);
                } else {
                    hideProfile();
                }
            });

            // Initial session check on page load
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    showProfile(session.user);
                } else {
                    hideProfile();
                }
            });

        }); // END DOMContentLoaded
    </script>
</body>

</html>
