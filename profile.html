<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const SUPABASE_URL = 'https://lhurtuuxsmlakoikcpiz.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxodXJ0dXV4c21sYWtvaWtjcGl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTIyNjEsImV4cCI6MjA3OTE2ODI2MX0.NiXIlUukeNB-gOANdbHSyfb6T9GcO7QqtlMsQgkEGKc';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const defaultAvatar =
    'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%23a3f7ff" opacity="0.2"/%3E%3Ccircle cx="50" cy="50" r="35" fill="none" stroke="%23a3f7ff" stroke-width="2"/%3E%3C/svg%3E';

  function saveToLocalStorage(username, avatarUrl, email) {
    try {
      if (username) localStorage.setItem('nebula_username', username);
      if (avatarUrl) localStorage.setItem('nebula_avatar', avatarUrl);
      if (email) localStorage.setItem('nebula_email', email);
    } catch (e) {
      console.error('localStorage save error', e);
    }
  }

  function getFromLocalStorage() {
    return {
      username: localStorage.getItem('nebula_username'),
      avatar: localStorage.getItem('nebula_avatar'),
      email: localStorage.getItem('nebula_email')
    };
  }

  function clearLocalStorage() {
    localStorage.removeItem('nebula_username');
    localStorage.removeItem('nebula_avatar');
    localStorage.removeItem('nebula_email');
  }

  function showError(m) {
    const el = document.getElementById('error-message');
    el.textContent = m;
    el.style.display = 'block';
    setTimeout(() => (el.style.display = 'none'), 5000);
  }

  function showSuccess(m) {
    const el = document.getElementById('success-message');
    el.textContent = m;
    el.style.display = 'block';
    setTimeout(() => (el.style.display = 'none'), 3000);
  }

  function showProfile(user) {
    const metadata = user?.user_metadata || {};
    const saved = getFromLocalStorage();

    const name =
      metadata.full_name ||
      user.full_name ||
      saved.username ||
      user.email ||
      'User';

    const avatar =
      metadata.avatar_url ||
      user.avatar_url ||
      saved.avatar ||
      defaultAvatar;

    const email = user.email || saved.email || '(no email)';

    saveToLocalStorage(name, avatar, email);

    document.getElementById('profile-status').textContent =
      'Signed in as ' + email;
    document.getElementById('profile-name').textContent = name;
    document.getElementById('profile-email').textContent = email;
    document.getElementById('profile-pic').src = avatar;

    document.getElementById('profile-card').classList.add('show');
    document.getElementById('auth-section').style.display = 'none';

    document.getElementById('editUsername').value = name;
    document.getElementById('avatarPreview').src = avatar;
  }

  function hideProfile() {
    document.getElementById('profile-status').textContent = 'Not signed in.';
    document.getElementById('profile-card').classList.remove('show');
    document.getElementById('auth-section').style.display = 'block';
  }

  supabase.auth.onAuthStateChange((event, session) => {
    if (session?.user) {
      const u = session.user;
      const saved = getFromLocalStorage();
      showProfile({
        full_name: u.user_metadata?.full_name || saved.username,
        avatar_url: u.user_metadata?.avatar_url || saved.avatar,
        email: u.email
      });
    } else {
      const saved = getFromLocalStorage();
      if (saved.username || saved.email) {
        showProfile({
          full_name: saved.username,
          avatar_url: saved.avatar,
          email: saved.email
        });
      } else {
        hideProfile();
      }
    }
  });

  document.getElementById('signInBtn').addEventListener('click', () => {
    document.getElementById('signInModal').classList.add('show');
  });

  document.getElementById('closeSignInBtn').addEventListener('click', () => {
    document.getElementById('signInModal').classList.remove('show');
  });

  document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('signInEmail').value.trim();
    const password = document.getElementById('signInPassword').value;

    if (!email || !password) return showError('Please fill in all fields');

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });

    if (error) return showError('Sign in failed: ' + error.message);

    const user = data.user;
    const name = user.user_metadata?.full_name || email;

    saveToLocalStorage(name, defaultAvatar, email);
    showProfile(user);
    showSuccess('Signed in!');

    document.getElementById('signInModal').classList.remove('show');
  });

  document.getElementById('signUpBtn').addEventListener('click', () => {
    document.getElementById('signUpModal').classList.add('show');
  });

  document.getElementById('closeSignUpBtn').addEventListener('click', () => {
    document.getElementById('signUpModal').classList.remove('show');
  });

  document.getElementById('createAccountBtn').addEventListener('click', async () => {
    const email = document.getElementById('signUpEmail').value.trim();
    const username = document.getElementById('signUpUsername').value.trim();
    const password = document.getElementById('signUpPassword').value;

    if (!email || !password || !username)
      return showError('Please fill in all fields');

    if (password.length < 6)
      return showError('Password must be at least 6 characters');

    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: window.location.origin + '/profile.html',
        data: {
          full_name: username,
          avatar_url: defaultAvatar
        }
      }
    });

    if (error) return showError('Sign up failed: ' + error.message);

    showSuccess('Check your email to verify your account!');
    document.getElementById('signUpModal').classList.remove('show');
  });

  // --------------------
  // GitHub OAuth
  // --------------------
  document.getElementById('githubBtn')?.addEventListener('click', async () => {
    try {
      await supabase.auth.signInWithOAuth({ provider: 'github' });
    } catch (e) {
      showError('GitHub sign in failed');
    }
  });

  // --------------------
  // SIGN OUT FUNCTION (FINAL)
  // --------------------
  document.getElementById('signOutBtn').addEventListener('click', async () => {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) return showError("Sign out failed: " + error.message);

      clearLocalStorage();
      hideProfile();
      showSuccess("Signed out successfully!");
    } catch (e) {
      showError("Error signing out: " + (e.message || e));
    }
  });
</script>
